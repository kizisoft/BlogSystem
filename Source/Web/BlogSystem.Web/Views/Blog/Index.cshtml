@using Microsoft.AspNet.Identity
@using BlogSystem.Web.Infrastructure.Constants
@model BlogSystem.Web.ViewModels.BlogPost.BlogPostIndexViewModel
@{
    ViewBag.Title = Model.Title;
}
<div class="content plate page">
    <section class="blog-post">
        <header class="article-header">
            <div class="date-holder">
                <ul class="text-center">
                    <li class="date-month">@((MonthName)Model.CreatedOn.Month)</li>
                    <li class="date-day">@Model.CreatedOn.Day</li>
                    <li class="date-year">@Model.CreatedOn.Year</li>
                </ul>
            </div>

            <div class="title article-title">
                <h2>@Model.Title</h2>
                <h3><i>@Model.SubTitle</i></h3>
            </div>

            <ul class="blog-info">
                <li>
                    <span class="glyphicon glyphicon-user"></span>
                    @Model.Autor.UserName
                </li>
                <li>
                    <span class="glyphicon glyphicon-calendar"></span>
                    @Model.CreatedOn.ToShortDateString()
                </li>
                <li>
                    <span class="glyphicon glyphicon-time"></span>
                    @Model.CreatedOn.ToShortTimeString()
                </li>
                <li>
                    <span class="glyphicon glyphicon-comment"></span>
                    @Model.CommentsCount Comments
                </li>
            </ul>
        </header>

        <article class="raw">
            @Html.Raw(Model.Content)
            <br />
            <p class="clearfix">
                @if (User.IsInRole(GlobalConstants.AdministratorRoleName))
                {
                    @Html.ActionLink("Edit", "Edit", "BlogPosts", new { Area = "Administration", Id = Model.Id }, new { @class = "btn btn-success btn-sm pull-right" })
                }
            </p>
        </article>

        <footer class="article-footer">
            <div class="g-plusone" data-href="@Model.Url"></div>
        </footer>
    </section>

    @Html.Partial("~/Views/Comment/_CommentsPartial.cshtml", Model.Id)

    @Html.Pager(Model.Pager.PreviousPage, Model.Pager.NextPage, new { @class = "blog-info" })
</div>

@section scripts {
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script type="text/javascript" src="~/Scripts/img-responsive/img-responsive.js"></script>
    <script type="text/javascript" src="~/Scripts/main.js"></script>
    <script type="text/javascript">
        function commentsLoaded() {
            $('#comments').on('click', 'a', function (e) {
                var $target = $(e.target),
                  $element, type, path, formData, xhr;

                $element = $target.closest('.vote-up') || $target.closest('.vote-down') || [];
                if ($element != []) {
                    e.preventDefault();
                    type = $element.data('type');
                    path = type === 'up' ? '@Url.Action("VoteUp", "Comment", new { id =Model.Id})' : '@Url.Action("VoteDown", "Comment", new { id = Model.Id })';
                    formData = new FormData(),
                    xhr = new XMLHttpRequest();
                    formData.append('__RequestVerificationToken', $('#comments-items input[name="__RequestVerificationToken"').val());
                    xhr.addEventListener('load', function (data) {
                        if (this.status == 200) {
                            $('#votes').replaceWith(data.target.response);
                            Notifier.notifyInfo('Thank you for your vote!');
                        } else {
                            showJsonError(data.target);
                        }
                    });
                    xhr.addEventListener('error', function (error) {
                        Notifier.notifyError('Something bad happend. Please try again!');
                    });

                    xhr.open("POST", path, true);
                    xhr.send(formData);
                }
            });
        }
    </script>
}